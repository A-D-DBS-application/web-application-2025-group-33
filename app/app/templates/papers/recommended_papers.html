{% extends "base.html" %}

{% block title %}Recommended Papers{% endblock %}

{% block content %}
<div class="card">
    <h1>Recommended Papers for You</h1>
    <p class="mt-1 text-muted-small">Based on your research interests and preferred researcher experience level.</p>
</div>

{% if papers %}
    <div class="paper-list">
        {% for paper in papers %}
            <div class="paper-item">
                <div class="paper-item-header">
                    <div class="paper-item-content">
                        <h3>
                            <a href="{{ url_for('papers.view_paper', paper_id=paper.id) }}" class="paper-title-link">
                                {{ paper.title }}
                            </a>
                        </h3>
                        
                        <div class="mt-2 mb-2">
                            {% if paper.relevance_score >= 75 %}
                                <span class="match-badge match-badge-high">Match: {{ paper.relevance_score }}%</span>
                            {% elif paper.relevance_score >= 50 %}
                                <span class="match-badge match-badge-medium">Match: {{ paper.relevance_score }}%</span>
                            {% else %}
                                <span class="match-badge match-badge-low">Match: {{ paper.relevance_score }}%</span>
                            {% endif %}
                            
                            <!-- Add business relevance badge if available -->
                            {% if paper.get('business_relevance_score', 0) > 0 %}
                                <span class="business-score-badge">
                                    ðŸ“Š Business Score: {{ paper.business_relevance_score }}%
                                </span>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="paper-meta">
                    <strong>Published:</strong> {{ paper.created_at.strftime('%B %d, %Y') }}
                </div>

                {% if paper.authors %}
                    <div class="paper-authors-section">
                        <strong>Authors:</strong>
                        <ul class="ml-3 mt-1">
                            {% for author in paper.authors %}
                                <li class="paper-author-item">
                                    <strong>{{ author.first_name }} {{ author.last_name }}</strong><br>
                                    <span class="paper-author-details">
                                        {{ author.university }}<br>
                                        {{ author.years_of_experience }} years in {{ author.field_of_research }}
                                    </span>
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                {% endif %}

                <div class="mt-2">
                    <a href="{{ url_for('papers.view_paper', paper_id=paper.id) }}" class="btn btn-small">View Details</a>
                    <a href="{{ url_for('papers.download_paper', paper_id=paper.id) }}" 
                       class="btn btn-small btn-secondary ml-1">Download PDF</a>
                </div>
            </div>
        {% endfor %}
    </div>
{% else %}
    <div class="card">
        <p class="text-muted-small">No recommended papers found at this time. Check back later as more papers are published!</p>
        <a href="{{ url_for('papers.company_dashboard') }}" class="btn mt-2">Browse All Papers</a>
    </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Toggle business critical status
        document.querySelectorAll('.toggle-critical').forEach(function(btn) {
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                
                var paperId = this.getAttribute('data-paper-id');
                
                fetch('/paper/' + paperId + '/interest/toggle-critical', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({})
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update button text and class
                        var status = data.is_business_critical ? 'unmark' : 'mark';
                        btn.classList.toggle('btn-success');
                        btn.classList.toggle('btn-secondary');
                        btn.innerHTML = data.is_business_critical ? 'Business Critical' : 'Mark as Business Critical';
                        
                        // Optionally, show a toast or alert
                        alert('Paper ' + (data.is_business_critical ? 'marked' : 'unmarked') + ' as business critical!');
                    } else {
                        alert('Error: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred. Please try again later.');
                });
            });
        });
    });
</script>
{% endblock %}
