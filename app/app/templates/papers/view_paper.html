{% extends "base.html" %}

{% block title %}{{ paper.title }}{% endblock %}

{% block content %}
  <div class="card">
    <div class="flex-between">
      <div>
        <h1>{{ paper.title }}
          {% if is_interested %}
            <span class="star">★</span>
          {% endif %}
        </h1>
        {% if session.user_type == 'author' %}
          <span class="badge badge-{{ paper.status }}">{{ paper.status }}</span>
        {% endif %}
      </div>
      <div>
        <a href="{{ url_for('papers.download_paper', paper_id=paper.id) }}" class="btn btn-secondary">Download PDF</a>
      </div>
    </div>

    <div class="mt-2">
      <strong>Created:</strong> {{ paper.created_at.strftime('%Y-%m-%d %H:%M') }} |
      <strong>Last Updated:</strong> {{ paper.updated_at.strftime('%Y-%m-%d %H:%M') }}
    </div>

    {% if session.user_type == 'author' and is_collaborator %}
      <!-- Publish paper action for authors -->
      <div class="mt-3 flex-gap-wrap">
        {% if paper.status == 'draft' %}
          <form method="POST" action="{{ url_for('papers.publish_paper', paper_id=paper.id) }}"
                onsubmit="return confirm('Are you sure you want to publish this paper? It will become visible to all companies.');"
                class="inline-form">
            <button type="submit" class="btn btn-success">Publish Paper</button>
          </form>
        {% else %}
          <span class="text-success">✓ Published - Visible to Companies</span>
        {% endif %}
      </div>
    {% endif %}

    {% if session.user_type == 'company' %}
      <!-- Interest toggle for companies -->
      <div class="mt-3">
        <form method="POST" action="{{ url_for('interests.toggle_interest', paper_id=paper.id) }}">
          {% if paper.is_interested %}
            <button type="submit" class="btn btn-danger">★ Remove from Interests</button>
          {% else %}
            <button type="submit" class="btn btn-success">☆ Mark as Interested</button>
          {% endif %}
        </form>
      </div>
    {% endif %}
  </div>

  {% if session.user_type == 'author' and is_collaborator %}
    <!-- Edit paper details and manage collaborators for authors -->
    <div class="card">
      <h2>Edit Paper Details</h2>

      <div class="mt-2">
        <h3>Update Title</h3>
        <form method="POST" action="{{ url_for('papers.update_paper', paper_id=paper.id) }}"
              class="mt-1">
          <div class="form-group">
            <label for="paper_title">Paper Title:</label>
            <input type="text" id="paper_title" name="title" value="{{ paper.title }}" required
                   class="max-w-600">
          </div>
          <button type="submit" class="btn btn-small">Save Title</button>
        </form>
      </div>

      <div class="mt-3">
        <h3>Upload New PDF Version</h3>
        <form method="POST" action="{{ url_for('papers.update_paper', paper_id=paper.id) }}"
              enctype="multipart/form-data" class="mt-1">
          <div class="form-group">
            <input type="file" id="pdf" name="pdf" accept=".pdf" required>
            <small class="text-muted">This will replace the current PDF file</small>
          </div>
          <button type="submit" class="btn btn-small">Upload PDF</button>
        </form>
      </div>
    </div>

    <div class="card">
      <!-- Collaborators management -->
      <h2>Collaborators</h2>
      <ul class="collaborators-list">
        {% for collab in paper.collaborators %}
          <li class="py-1 bb">
            <div>
              <strong>{{ collab.first_name }} {{ collab.last_name }}</strong>
              {% if collab.university %}
                <span class="text-muted"> - {{ collab.university }}</span>
              {% endif %}
              {% if collab.id == paper.created_by %}
                <span class="badge badge-creator ml-1">Creator</span>
              {% endif %}
            </div>
            {% if session.user_type == 'author' and is_collaborator and collab.id != paper.created_by %}
              <form method="POST"
                    action="{{ url_for('collaborators.remove_collaborator', paper_id=paper.id, collaborator_id=collab.id) }}"
                    class="inline-form"
                    onsubmit="return confirm('Are you sure you want to remove this collaborator?');">
                <button type="submit" class="btn btn-small btn-danger">Remove</button>
              </form>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <div class="mt-3 callout-success">
        <h3 class="mt-0">Add Collaborator</h3>
        <p class="text-muted mb-1">Invite another author to collaborate on this paper. They must have
          an existing author account.</p>
        <form method="POST" action="{{ url_for('collaborators.add_collaborator', paper_id=paper.id) }}">
          <div class="form-group">
            <label for="collaborator_email"><strong>Author Email:</strong></label>
            <input type="email" id="collaborator_email" name="collaborator_email" required
                   placeholder="author@university.edu" class="max-w-400">
          </div>
          <button type="submit" class="btn btn-success">Add Collaborator</button>
        </form>
      </div>
    </div>
  {% endif %}

  {% if session.user_type == 'author' and paper.status == 'published' and paper.interested_companies %}
    <!-- Interested companies for authors -->
    <div class="card">
      <h2>Interested Companies ({{ paper.interested_companies|length }})</h2>
      <p class="text-muted">These companies have marked your paper as interesting:</p>
      <ul class="companies-list">
        {% for interest in paper.interested_companies %}
          <li class="py-1">{{ interest.company_name }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if session.user_type == 'company' %}
    <!-- Authors info for companies -->
    <div class="card">
      <h2>Authors</h2>
      <ul class="collaborators-list">
        {% for author in paper.authors %}
          <li class="py-1">
            <strong>{{ author.first_name }} {{ author.last_name }}</strong>
            {% if author.university %}
              <span class="text-muted"> - {{ author.university }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div class="mt-3">
    <a href="{{ url_for('papers.author_dashboard' if session.user_type == 'author' else 'papers.company_dashboard') }}"
       class="btn btn-secondary">← Back to Dashboard</a>
  </div>
{% endblock %}

