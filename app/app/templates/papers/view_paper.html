{% extends "base.html" %}

{% block title %}{{ paper.title }}{% endblock %}

{% block content %}
  <div class="card">
    <div class="flex-between">
      <div>
        <h1>{{ paper.title }}
          {% if is_interested %}
            <span class="star">★</span>
          {% endif %}
        </h1>
        {% if session.user_type == 'author' %}
          <span class="badge badge-{{ paper.status }}">{{ paper.status }}</span>
        {% endif %}
      </div>
      <div>
        <a href="{{ url_for('papers.download_paper', paper_id=paper.id) }}" class="btn btn-secondary">Download PDF</a>
      </div>
    </div>

    <div class="mt-2">
      <strong>Created:</strong> {{ paper.created_at.strftime('%Y-%m-%d %H:%M') }} |
      <strong>Last Updated:</strong> {{ paper.updated_at.strftime('%Y-%m-%d %H:%M') }}
    </div>

    {% if session.user_type == 'author' and is_collaborator %}
      <!-- Publish paper action for authors -->
      <div class="mt-3 flex-gap-wrap">
        {% if paper.status == 'draft' %}
          <form method="POST" action="{{ url_for('papers.publish_paper', paper_id=paper.id) }}"
                onsubmit="return confirm('Are you sure you want to publish this paper? It will become visible to all companies.');"
                class="inline-form">
            <button type="submit" class="btn btn-success">Publish Paper</button>
          </form>
        {% else %}
          <span class="text-success">✓ Published - Visible to Companies</span>
        {% endif %}
        
        <form method="POST" action="{{ url_for('papers.delete_paper', paper_id=paper.id) }}"
              onsubmit="return confirm('Are you sure you want to delete this paper? This action cannot be undone.');"
              class="inline-form">
          <button type="submit" class="btn btn-danger">Delete Paper</button>
        </form>
      </div>
    {% endif %}

    {% if session.user_type == 'company' %}
      <!-- Interest toggle for companies -->
      <div class="mt-3">
        <form method="POST" action="{{ url_for('interests.toggle_interest', paper_id=paper.id) }}">
          {% if paper.is_interested %}
            <button type="submit" class="btn btn-danger">★ Remove from Interests</button>
          {% else %}
            <button type="submit" class="btn btn-success">☆ Mark as Interested</button>
          {% endif %}
        </form>
      </div>
    {% endif %}
  </div>

  {% if session.user_type == 'author' and is_collaborator %}
    <!-- Edit paper details and manage collaborators for authors -->
    <div class="card">
      <h2>Edit Paper Details</h2>

      <div class="mt-2">
        <h3>Update Title</h3>
        <form method="POST" action="{{ url_for('papers.update_paper', paper_id=paper.id) }}"
              class="mt-1">
          <div class="form-group">
            <label for="paper_title">Paper Title:</label>
            <input type="text" id="paper_title" name="title" value="{{ paper.title }}" required
                   class="max-w-600">
          </div>
          <button type="submit" class="btn btn-small">Save Title</button>
        </form>
      </div>

      <div class="mt-3">
        <h3>Update Subject</h3>
        <form method="POST" action="{{ url_for('papers.update_paper', paper_id=paper.id) }}"
              class="mt-1">
          <div class="form-group">
            <label for="paper_subject">Paper Subject:</label>
            <input type="text" id="paper_subject" name="subject" value="{{ paper.subject or '' }}"
                   placeholder="e.g., Machine Learning, AI, Data Science"
                   class="max-w-600">
            <small class="text-muted">Separate multiple subjects with commas. This helps companies find your paper.</small>
          </div>
          <button type="submit" class="btn btn-small">Save Subject</button>
        </form>
      </div>

      <div class="mt-3">
        <h3>Upload New PDF Version</h3>
        <form method="POST" action="{{ url_for('papers.update_paper', paper_id=paper.id) }}"
              enctype="multipart/form-data" class="mt-1">
          <div class="form-group">
            <input type="file" id="pdf" name="pdf" accept=".pdf" required>
            <small class="text-muted">This will replace the current PDF file</small>
          </div>
          <button type="submit" class="btn btn-small">Upload PDF</button>
        </form>
      </div>
    </div>

    <div class="card">
      <!-- Collaborators management -->
      <h2>Collaborators</h2>
      <ul class="collaborators-list">
        {% for collab in paper.collaborators %}
          <li class="py-1 bb">
            <div>
              <strong>{{ collab.first_name }} {{ collab.last_name }}</strong>
              {% if collab.university %}
                <span class="text-muted"> - {{ collab.university }}</span>
              {% endif %}
              {% if collab.id == paper.created_by %}
                <span class="badge badge-creator ml-1">Creator</span>
              {% endif %}
            </div>
            {% if session.user_type == 'author' and is_collaborator and collab.id != paper.created_by %}
              <form method="POST"
                    action="{{ url_for('collaborators.remove_collaborator', paper_id=paper.id, collaborator_id=collab.id) }}"
                    class="inline-form"
                    onsubmit="return confirm('Are you sure you want to remove this collaborator?');">
                <button type="submit" class="btn btn-small btn-danger">Remove</button>
              </form>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <div class="mt-3 callout-success">
        <h3 class="mt-0">Add Collaborator</h3>
        <p class="text-muted mb-1">Invite another author to collaborate on this paper. They must have
          an existing author account.</p>
        <form method="POST" action="{{ url_for('collaborators.add_collaborator', paper_id=paper.id) }}">
          <div class="form-group">
            <label for="collaborator_email"><strong>Author Email:</strong></label>
            <input type="email" id="collaborator_email" name="collaborator_email" required
                   placeholder="author@university.edu" class="max-w-400">
          </div>
          <button type="submit" class="btn btn-success">Add Collaborator</button>
        </form>
      </div>
    </div>
  {% endif %}

  {% if session.user_type == 'author' and paper.status == 'published' %}
    <!-- Paper Statistics for authors -->
    <div class="card">
      <h2>Paper Statistics</h2>
      
      <!-- Download Counter -->
      <div class="stat-counter">
        <div class="stat-counter-number">{{ paper.download_count or 0 }}</div>
        <div class="stat-counter-label">Total Downloads</div>
      </div>
      
      {% if paper.interested_companies %}
        <!-- Interested Companies -->
        <h3>Interested Companies ({{ paper.interested_companies|length }})</h3>
        <p class="text-muted">These companies have marked your paper as interesting:</p>
        <ul class="companies-list">
          {% for interest in paper.interested_companies %}
            <li class="py-1">{{ interest.company_name }}</li>
          {% endfor %}
        </ul>
      {% else %}
        <p class="text-muted mt-2">No companies have marked interest in this paper yet.</p>
      {% endif %}
    </div>
  {% endif %}

  {% if session.user_type == 'company' %}
    <!-- Authors info for companies -->
    <div class="card">
      <h2>Authors</h2>
      <ul class="collaborators-list">
        {% for author in paper.authors %}
          <li class="py-1">
            <strong>{{ author.first_name }} {{ author.last_name }}</strong>
            {% if author.university %}
              <span class="text-muted"> - {{ author.university }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>

    <!-- Paper Statistics for companies -->
    <div class="card">
      <h2>Paper Statistics</h2>
      
      <div class="stat-counter-grid">
        <!-- Download Counter -->
        <div class="stat-counter-item stat-counter-item-blue">
          <div class="stat-counter-item-number stat-counter-item-number-blue">{{ paper.download_count or 0 }}</div>
          <div class="stat-counter-item-label">Total Downloads</div>
        </div>
        
        <!-- Interest Counter -->
        <div class="stat-counter-item stat-counter-item-yellow">
          <div class="stat-counter-item-number stat-counter-item-number-yellow">{{ paper.interest_count or 0 }}</div>
          <div class="stat-counter-item-label">Companies Interested</div>
        </div>
      </div>
    </div>

    <!-- Business Relevance Section -->
    <div class="card business-relevance-card">
      <h2>Business Relevance</h2>
      
      <div class="business-relevance-content">
          <div>
              <strong>Business Relevance Score:</strong>
              <div class="business-relevance-score">
                  {{ paper.get('business_relevance_score', 0) }}%
              </div>
          </div>
      </div>
    </div>
  {% endif %}

  <!-- Reviews Section - Only for published papers -->
  {% if paper.status == 'published' %}
    <div class="card">
      <h2>Reviews 
        {% if avg_rating %}
          <span class="review-rating-display">★ {{ avg_rating }}/5</span>
          <span class="review-count">({{ reviews|length }} review{% if reviews|length != 1 %}s{% endif %})</span>
        {% endif %}
      </h2>
      
      {% if not user_has_reviewed and not is_collaborator %}
        <div class="review-form-container">
          <h3>Leave a Review</h3>
          <form method="POST" action="{{ url_for('papers.submit_review', paper_id=paper.id) }}">
            <div class="form-group">
              <label><strong>Rating:</strong></label>
              <div class="star-rating">
                {% for i in range(1, 6) %}
                  <label>
                    <input type="radio" name="rating" value="{{ i }}" required>
                    <span class="star" data-value="{{ i }}">★</span>
                  </label>
                {% endfor %}
              </div>
            </div>
            <div class="form-group">
              <label for="comment"><strong>Comment (optional):</strong></label>
              <textarea id="comment" name="comment" rows="3" placeholder="Share your thoughts about this paper..." class="input-full-width"></textarea>
            </div>
            <button type="submit" class="btn btn-success">Submit Review</button>
          </form>
        </div>
        
        <script>
          document.querySelectorAll('.star-rating .star').forEach(star => {
            star.addEventListener('click', function() {
              const value = this.getAttribute('data-value');
              const container = this.closest('.star-rating');
              container.querySelectorAll('.star').forEach((s, idx) => {
                s.style.color = idx < value ? '#f39c12' : '#ccc';
              });
              this.previousElementSibling.checked = true;
            });
            star.addEventListener('mouseover', function() {
              const value = this.getAttribute('data-value');
              const container = this.closest('.star-rating');
              container.querySelectorAll('.star').forEach((s, idx) => {
                s.style.color = idx < value ? '#f39c12' : '#ccc';
              });
            });
          });
          document.querySelectorAll('.star-rating').forEach(container => {
            container.addEventListener('mouseleave', function() {
              const checked = this.querySelector('input:checked');
              const value = checked ? checked.value : 0;
              this.querySelectorAll('.star').forEach((s, idx) => {
                s.style.color = idx < value ? '#f39c12' : '#ccc';
              });
            });
          });
        </script>
      {% elif is_collaborator %}
        <p class="text-muted text-italic mb-1">You cannot review your own paper.</p>
      {% else %}
        <p class="text-muted text-italic mb-1">You have already reviewed this paper.</p>
      {% endif %}
      
      {% if reviews %}
        <div class="mt-2">
          {% for review in reviews %}
            <div class="review-item">
              <div class="review-header">
                <div>
                  <strong>{{ review.reviewer_name }}</strong>
                  <span class="reviewer-badge {% if review.reviewer_type == 'company' %}reviewer-badge-company{% endif %}">
                    {{ review.reviewer_type|capitalize }}
                  </span>
                </div>
                <span class="review-date">{{ review.created_at.strftime('%Y-%m-%d') }}</span>
              </div>
              <div class="review-rating">
                {% for i in range(5) %}
                  {% if i < review.rating %}★{% else %}<span class="star-inactive">★</span>{% endif %}
                {% endfor %}
              </div>
              {% if review.comment %}
                <p class="review-comment">{{ review.comment }}</p>
              {% endif %}
              
              <!-- Edit and Delete buttons for company's own reviews -->
              {% if session.user_type == 'company' and review.company_id == session.user_id %}
                <div class="review-edit-actions">
                  <button class="btn btn-small" onclick="toggleEditReview({{ review.id }})">Edit</button>
                  <form method="POST" action="{{ url_for('papers.delete_review', review_id=review.id) }}"
                        onsubmit="return confirm('Are you sure you want to delete this review?');"
                        class="inline-form">
                    <button type="submit" class="btn btn-small btn-danger">Delete</button>
                  </form>
                </div>
                
                <!-- Edit form (hidden by default) -->
                <div id="edit-review-{{ review.id }}" class="review-edit-form">
                  <form method="POST" action="{{ url_for('papers.edit_review', review_id=review.id) }}">
                    <div class="form-group">
                      <label><strong>Rating:</strong></label>
                      <div class="star-rating-edit">
                        {% for i in range(1, 6) %}
                          <label>
                            <input type="radio" name="rating" value="{{ i }}" {% if i == review.rating %}checked{% endif %} required>
                            <span class="star-edit {% if i <= review.rating %}active{% endif %}" data-value="{{ i }}">★</span>
                          </label>
                        {% endfor %}
                      </div>
                    </div>
                    <div class="form-group">
                      <label for="edit-comment-{{ review.id }}"><strong>Comment:</strong></label>
                      <textarea id="edit-comment-{{ review.id }}" name="comment" rows="3" class="input-full-width">{{ review.comment or '' }}</textarea>
                    </div>
                    <div class="review-edit-actions">
                      <button type="submit" class="btn btn-success">Save Changes</button>
                      <button type="button" class="btn btn-secondary" onclick="toggleEditReview({{ review.id }})">Cancel</button>
                    </div>
                  </form>
                </div>
              {% endif %}
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="text-muted">No reviews yet. Be the first to review this paper!</p>
      {% endif %}
    </div>
  {% endif %}

  <script>
    function toggleEditReview(reviewId) {
      const editForm = document.getElementById('edit-review-' + reviewId);
      editForm.style.display = editForm.style.display === 'none' ? 'block' : 'none';
    }
    
    // Star rating interaction for edit forms
    document.querySelectorAll('.star-rating-edit .star-edit').forEach(star => {
      star.addEventListener('click', function() {
        const value = this.getAttribute('data-value');
        const container = this.closest('.star-rating-edit');
        container.querySelectorAll('.star-edit').forEach((s, idx) => {
          s.style.color = idx < value ? '#f39c12' : '#ccc';
        });
        this.previousElementSibling.checked = true;
      });
      star.addEventListener('mouseover', function() {
        const value = this.getAttribute('data-value');
        const container = this.closest('.star-rating-edit');
        container.querySelectorAll('.star-edit').forEach((s, idx) => {
          s.style.color = idx < value ? '#f39c12' : '#ccc';
        });
      });
    });
    document.querySelectorAll('.star-rating-edit').forEach(container => {
      container.addEventListener('mouseleave', function() {
        const checked = this.querySelector('input:checked');
        const value = checked ? checked.value : 0;
        this.querySelectorAll('.star-edit').forEach((s, idx) => {
          s.style.color = idx < value ? '#f39c12' : '#ccc';
        });
      });
    });
  </script>

  <div class="mt-3">
    <a href="{{ url_for('papers.author_dashboard' if session.user_type == 'author' else 'papers.company_dashboard') }}"
       class="btn btn-secondary">← Back to Dashboard</a>
  </div>
{% endblock %}

