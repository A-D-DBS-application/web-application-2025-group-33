{% extends "base.html" %}

{% block title %}{{ paper.title }}{% endblock %}

{% block content %}
  <div class="card">
    <div style="display: flex; justify-content: space-between; align-items: start;">
      <div>
        <h1>{{ paper.title }}
          {% if is_interested %}
            <span style="color: #e74c3c;">★</span>
          {% endif %}
        </h1>
        {% if session.user_type == 'author' %}
          <span class="badge badge-{{ paper.status }}">{{ paper.status }}</span>
        {% endif %}
      </div>
      <div>
        <a href="{{ url_for('papers.download_paper', paper_id=paper.id) }}" class="btn btn-secondary">Download PDF</a>
      </div>
    </div>

    <div style="margin-top: 1rem;">
      <strong>Created:</strong> {{ paper.created_at.strftime('%Y-%m-%d %H:%M') }} |
      <strong>Last Updated:</strong> {{ paper.updated_at.strftime('%Y-%m-%d %H:%M') }}
    </div>

    {% if session.user_type == 'author' and is_collaborator %}
      <!-- Publish paper action for authors -->
      <div style="margin-top: 1.5rem; display: flex; gap: 1rem; flex-wrap: wrap;">
        {% if paper.status == 'draft' %}
          <form method="POST" action="{{ url_for('papers.publish_paper', paper_id=paper.id) }}"
                onsubmit="return confirm('Are you sure you want to publish this paper? It will become visible to all companies.');"
                style="display: inline;">
            <button type="submit" class="btn btn-success">Publish Paper</button>
          </form>
        {% else %}
          <span style="color: #27ae60; font-weight: bold;">✓ Published - Visible to Companies</span>
        {% endif %}
      </div>
    {% endif %}

    {% if session.user_type == 'company' %}
      <!-- Interest toggle for companies -->
      <div style="margin-top: 1.5rem;">
        <form method="POST" action="{{ url_for('interests.toggle_interest', paper_id=paper.id) }}">
          {% if paper.is_interested %}
            <button type="submit" class="btn btn-danger">★ Remove from Interests</button>
          {% else %}
            <button type="submit" class="btn btn-success">☆ Mark as Interested</button>
          {% endif %}
        </form>
      </div>
    {% endif %}
  </div>

  {% if session.user_type == 'author' and is_collaborator %}
    <!-- Edit paper details and manage collaborators for authors -->
    <div class="card">
      <h2>Edit Paper Details</h2>

      <div style="margin-top: 1rem;">
        <h3>Update Title</h3>
        <form method="POST" action="{{ url_for('papers.update_paper', paper_id=paper.id) }}"
              style="margin-top: 0.5rem;">
          <div class="form-group">
            <label for="paper_title">Paper Title:</label>
            <input type="text" id="paper_title" name="title" value="{{ paper.title }}" required
                   style="width: 100%; max-width: 600px;">
          </div>
          <button type="submit" class="btn btn-small">Save Title</button>
        </form>
      </div>

      <div style="margin-top: 1.5rem;">
        <h3>Upload New PDF Version</h3>
        <form method="POST" action="{{ url_for('papers.update_paper', paper_id=paper.id) }}"
              enctype="multipart/form-data" style="margin-top: 0.5rem;">
          <div class="form-group">
            <input type="file" id="pdf" name="pdf" accept=".pdf" required>
            <small style="color: #666;">This will replace the current PDF file</small>
          </div>
          <button type="submit" class="btn btn-small">Upload PDF</button>
        </form>
      </div>
    </div>

    <div class="card">
      <!-- Collaborators management -->
      <h2>Collaborators</h2>
      <ul class="collaborators-list">
        {% for collab in paper.collaborators %}
          <li
            style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid #eee;">
            <div>
              <strong>{{ collab.first_name }} {{ collab.last_name }}</strong>
              {% if collab.university %}
                <span style="color: #666;"> - {{ collab.university }}</span>
              {% endif %}
              {% if collab.id == paper.created_by %}
                <span class="badge" style="background-color: #3498db; margin-left: 0.5rem;">Creator</span>
              {% endif %}
            </div>
            {% if session.user_type == 'author' and is_collaborator and collab.id != paper.created_by %}
              <form method="POST"
                    action="{{ url_for('collaborators.remove_collaborator', paper_id=paper.id, collaborator_id=collab.id) }}"
                    style="display: inline;"
                    onsubmit="return confirm('Are you sure you want to remove this collaborator?');">
                <button type="submit" class="btn btn-small btn-danger">Remove</button>
              </form>
            {% endif %}
          </li>
        {% endfor %}
      </ul>

      <div
        style="margin-top: 1.5rem; padding: 1.5rem; background-color: #e8f5e9; border-radius: 4px; border: 2px solid #4caf50;">
        <h3 style="margin-top: 0;">Add Collaborator</h3>
        <p style="color: #666; margin-bottom: 1rem;">Invite another author to collaborate on this paper. They must have
          an existing author account.</p>
        <form method="POST" action="{{ url_for('collaborators.add_collaborator', paper_id=paper.id) }}">
          <div class="form-group">
            <label for="collaborator_email"><strong>Author Email:</strong></label>
            <input type="email" id="collaborator_email" name="collaborator_email" required
                   placeholder="author@university.edu" style="width: 100%; max-width: 400px;">
          </div>
          <button type="submit" class="btn btn-success">Add Collaborator</button>
        </form>
      </div>
    </div>
  {% endif %}

  {% if session.user_type == 'author' and paper.status == 'published' and paper.interested_companies %}
    <!-- Interested companies for authors -->
    <div class="card">
      <h2>Interested Companies ({{ paper.interested_companies|length }})</h2>
      <p style="color: #666;">These companies have marked your paper as interesting:</p>
      <ul class="companies-list">
        {% for interest in paper.interested_companies %}
          <li style="padding: 0.5rem 0;">{{ interest.company_name }}</li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% if session.user_type == 'company' %}
    <!-- Authors info for companies -->
    <div class="card">
      <h2>Authors</h2>
      <ul class="collaborators-list">
        {% for author in paper.authors %}
          <li style="padding: 0.5rem 0;">
            <strong>{{ author.first_name }} {{ author.last_name }}</strong>
            {% if author.university %}
              <span style="color: #666;"> - {{ author.university }}</span>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  <div style="margin-top: 1.5rem;">
    <a href="{{ url_for('papers.author_dashboard' if session.user_type == 'author' else 'papers.company_dashboard') }}"
       class="btn btn-secondary">← Back to Dashboard</a>
  </div>
{% endblock %}

